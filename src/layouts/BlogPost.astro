---
import type { CollectionEntry } from "astro:content";
import type { MarkdownHeading } from "astro";
import MainLayout from "@/layouts/MainLayout.astro";
import FormattedDate from "@/components/FormattedDate.astro";
import { TocSidebar } from "@/components/react/toc-sidebar";
import { TocMobile } from "@/components/react/toc-mobile";
import { ScrollToTop } from "@/components/react/scroll-to-top";

type Props = CollectionEntry<"blog">["data"] & {
  headings?: MarkdownHeading[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;
---

<MainLayout title={title} description={description}>
  <div class="relative min-h-screen bg-bg-primary text-text-primary">
    <div class="relative z-10 min-h-screen flex flex-col">
      <main class="flex-1 px-6 py-12">
        <div id="blog-content" class="max-w-4xl mx-auto space-y-8">
          <div class="space-y-4 border-b border-border-primary pb-8">
            <a
              href="/blog"
              class="inline-flex items-center gap-2 text-sm text-text-secondary hover:text-text-primary transition-colors tracking-wider"
            >
              <span>{"<"}</span>
              <span>BACK TO BLOG</span>
            </a>
            <h1 class="text-3xl md:text-5xl tracking-tight font-light leading-tight text-text-primary">
              {title}
            </h1>
            <div class="flex items-center gap-4 text-sm text-text-secondary tracking-wider">
              <FormattedDate date={pubDate} />
              {
                updatedDate && (
                  <>
                    <span>•</span>
                    <span>Updated <FormattedDate date={updatedDate} /></span>
                  </>
                )
              }
            </div>
          </div>

          {/* Mobile TOC - hidden on desktop (>=1200px) */}
          {headings.length > 0 && (
            <div class="block [@media(min-width:1200px)]:hidden">
              <TocMobile headings={headings} client:load />
            </div>
          )}

          <article class="prose prose-invert prose-sm md:prose-base max-w-none">
            <slot />
          </article>
        </div>

        {/* Desktop TOC Sidebar - hidden on mobile (<1200px) */}
        {headings.length > 0 && (
          <div class="hidden [@media(min-width:1200px)]:block">
            <TocSidebar headings={headings} client:load />
          </div>
        )}
      </main>

      <footer class="border-t border-border-primary backdrop-blur-sm">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between text-xs text-text-secondary">
          <div class="tracking-widest">© {new Date().getFullYear()}</div>
        </div>
      </footer>
    </div>
  </div>
  <ScrollToTop client:load />
</MainLayout>

<style is:global>
  article.prose {
    @apply leading-relaxed;
    color: var(--text-primary);
    line-height: 1.8;
    font-size: 1rem;
  }

  @media (min-width: 768px) {
    article.prose {
      font-size: 1.0625rem;
      line-height: 1.85;
    }
  }

  article.prose h1,
  article.prose h2,
  article.prose h3,
  article.prose h4,
  article.prose h5,
  article.prose h6 {
    @apply tracking-tight pb-3 mb-6;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-primary);
    font-weight: 300;
  }

  article.prose h1 {
    @apply text-3xl md:text-4xl mt-12;
  }

  article.prose h2 {
    @apply text-2xl md:text-3xl mt-12 mb-6;
  }

  article.prose h3 {
    @apply text-xl md:text-2xl mt-10 mb-5;
  }

  article.prose h4 {
    @apply mt-8;
  }

  article.prose p {
    @apply mb-6;
    color: var(--text-secondary);
  }

  article.prose a {
    @apply underline transition-colors;
    color: var(--accent-primary);
    text-decoration-color: rgba(126, 184, 218, 0.4);
  }

  article.prose a:hover {
    text-decoration-color: var(--accent-primary);
  }

  /* Inline code (not in pre blocks) */
  article.prose :not(pre) > code {
    @apply px-1.5 py-0.5 text-sm;
    background-color: var(--bg-elevated);
    border: 1px solid var(--border-primary);
  }

  /* Code blocks - minimal styling to let Shiki handle colors */
  article.prose pre {
    @apply p-5 overflow-x-auto my-8;
    background-color: var(--bg-surface) !important;
    border: 1px solid var(--border-primary);
    line-height: 1.6;
  }

  article.prose pre code {
    @apply text-sm;
    font-size: 0.9rem;
  }

  article.prose ul,
  article.prose ol {
    @apply my-6 space-y-3;
    color: var(--text-secondary);
  }

  article.prose li {
    @apply ml-6;
    line-height: 1.8;
  }

  article.prose li p {
    @apply my-2;
  }

  article.prose blockquote {
    @apply pl-6 py-2 italic my-8;
    border-left: 2px solid var(--border-hover);
    color: var(--text-secondary);
  }

  article.prose img {
    @apply my-6;
    border: 1px solid var(--border-hover);
  }

  article.prose table {
    @apply w-full border-collapse my-6;
  }

  article.prose th,
  article.prose td {
    @apply px-4 py-2 text-left;
    border: 1px solid var(--border-primary);
  }

  article.prose th {
    @apply tracking-wider;
    background-color: var(--bg-surface);
    font-weight: 400;
  }

  article.prose hr {
    @apply my-8;
    border-color: var(--border-primary);
  }
</style>
